# 系統完整概述

**📅 更新日期**: 2025-10-15  
**🔧 系統版本**: 3.0（K/C/R 三維度分類系統）

---

## 📋 目錄

1. [系統簡介](#系統簡介)
2. [核心功能](#核心功能)
3. [系統架構](#系統架構)
4. [工作流程](#工作流程)
5. [技術特點](#技術特點)
6. [使用場景](#使用場景)

---

## 系統簡介

### 什麼是 RAG 教學問答系統？

**RAG（Retrieval-Augmented Generation）教學問答系統**是一個智能問答系統，結合了：

- **向量檢索**：快速找到相關教材
- **三維度分類**：K/C/R 自動分析問題特徵
- **情境匹配**：根據分類結果匹配12種情境
- **並行處理**：RAG + 維度判定同時執行，提升效率
- **精確計時**：獨立追蹤每個階段的執行時間
- **優化架構**：3個 API 調用 + 本地計算，更快更高效

### 系統特色

✨ **智能分類**：K/C/R 三維度自動判定（知識點數量、正確性、重複性）  
🚀 **真正並行**：RAG + API 調用同時執行，節省處理時間  
📊 **精確計時**：並行分支獨立計時，清楚了解每個階段耗時  
🎯 **12種情境**：3×2×2 的組合，覆蓋所有教學場景  
⚡ **優化邏輯**：K值和R值本地計算，更快更準確  
🌐 **Web 界面**：美觀的互動式界面，易於使用

---

## 核心功能

### 1. K/C/R 三維度分類系統

| 維度 | 名稱 | 判斷方式 | 可能值 |
|------|------|----------|--------|
| **K** | 知識點數量 (Knowledge) | 從知識點檢測結果計算（中文精確匹配） | 0=零個、1=一個、2=多個 |
| **C** | 正確性 (Correctness) | API 判斷 | 0=正確、1=不正確 |
| **R** | 重複性 (Repetition) | 本地檢查歷史記錄 | 0=正常、1=重複 |

#### K - 知識點數量

**判斷邏輯**：從知識點檢測 API 的結果計算；檢測規則為「中文原字串精確匹配」，僅當問題文字中出現與節點名稱完全一致的字串才算命中。

- **0 (零個)**：沒有匹配到任何知識點
- **1 (一個)**：匹配到單一知識點
- **2 (多個)**：匹配到多個知識點

#### C - 正確性

**判斷邏輯**：AI 分析問題的表達是否正確

- **0 (正確)**：表達清晰正確
- **1 (不正確)**：概念混淆、語法錯誤（如："機器學習是不是就是深度學習？"）

#### R - 重複性

**判斷邏輯**：檢查前兩次歷史記錄

- **0 (正常)**：首次或不重複的問題
- **1 (重複)**：連續詢問相同知識點

**重複判定規則**：
1. 找出前兩次共同出現的知識點
2. 檢查當前知識點是否與共同知識點重疊
3. 若有重疊 → 重複（返回1）

### 2. 12種情境組合

3（K）× 2（C）× 2（R）= **12 種情境**

**情境計算公式**：`scenario_number = k*4 + c*2 + r + 1` (1-12)

每種情境都有對應的回答策略和提示詞模板。

**情境範例**：

| 情境 | K | C | R | 說明 |
|------|---|---|---|------|
| 情境 1 | 零個 | 正確 | 正常 | 確認意圖，介紹可學習的主題 |
| 情境 5 | 一個 | 正確 | 正常 | 基礎講解，最常見的情況 |
| 情境 6 | 一個 | 正確 | 重複 | 換角度講解，引導檢查理解盲點 |
| 情境 9 | 多個 | 正確 | 正常 | 完整整合，說明概念關係 |
| 情境 12 | 多個 | 不正確 | 重複 | 整合糾錯，回顧先備知識 |

### 3. 並行處理架構

**並行執行設計**：

```
用戶問題
    ↓
┌─────────────────────────────────────┐
│      並行處理（同時執行）            │
│                                     │
│  Thread 1: RAG Embedding API        │
│  Thread 2: C值檢測 API              │
│  Thread 3: 知識點檢測 API           │
│                                     │
└─────────────────────────────────────┘
    ↓
本地計算
├─ K值 = len(knowledge_points)
└─ R值 = repetition_checker.check_and_update()
    ↓
計算情境編號 (1-12)
    ↓
生成最終答案（流式輸出）
```

**效率提升**：
- 3個API並行執行，取最長時間
- K值和R值本地計算（幾乎無延遲）
- **並行效率**：約 70%

### 4. 精確計時系統

**獨立追蹤**：

- **Thread A 計時**：RAG檢索（Embedding API + 相似度計算）
- **Thread 2 計時**：C值檢測 API
- **Thread 3 計時**：知識點檢測 API
- **本地計算**：K值和R值計算時間
- **主流程計時**：並行處理、最終生成、總流程

**輸出範例**：
```
======================================================================
⏱️  詳細時間分析報告（3 個並行執行緒）
======================================================================

【並行執行詳情】
  Thread 1 - RAG 檢索:
    ├─ Embedding API 調用: 0.234s
    ├─ 相似度計算: 0.012s
    └─ 總耗時: 0.246s

  Thread 2 - C 值檢測:
    └─ API 調用耗時: 0.312s

  Thread 3 - 知識點檢測:
    └─ API 調用耗時: 0.289s

  本地計算 (K/R 值):
    └─ 計算耗時: 0.000123s

  並行執行總時間: 0.312s
  理論最大時間: 0.312s
  並行效率: 70.5%

======================================================================
```

---

## 系統架構

### 文件結構

```
test_Time_RAG_stream/
├── main_parallel.py              # 主程序（並行處理版本）
├── web_api.py                    # Web API 後端
├── config.py                     # 系統配置
├── pyproject.toml                # Poetry 依賴管理
│
├── core/                         # 核心模組
│   ├── __init__.py
│   ├── vector_store.py           # 向量存儲（支援本地/OpenAI）
│   ├── rag_module.py             # RAG 檢索與緩存
│   ├── scenario_classifier.py   # 情境分類器（12種）
│   ├── dimension_classifier.py   # 維度分類器（K/C/R）
│   ├── scenario_calculator.py    # 情境編號計算
│   ├── ontology_manager.py       # 本體論管理
│   ├── history_manager.py        # 歷史記錄管理
│   ├── timer_utils.py            # 並行計時工具
│   └── tools/                    # 檢測工具
│       ├── correctness_detector.py    # C值檢測
│       ├── knowledge_detector.py      # 知識點檢測
│       └── repetition_checker.py      # R值檢測
│
├── data/                         # 數據目錄
│   ├── docs/                     # 教材文件
│   │   ├── ml_basics.txt
│   │   ├── deep_learning.txt
│   │   └── nlp_intro.txt
│   ├── scenarios/                # 情境配置
│   │   └── scenarios_12.json
│   └── knowledge_points.json     # 簡化的知識點清單（僅節點）
│
├── web/                          # Web 前端
│   ├── index.html                # 主界面
│   └── app.js                    # JavaScript 邏輯
│
├── tests/                        # 測試文件
│   └── test_system.py
│
├── scripts/                      # 工具腳本
│   └── run_test.py
│
└── README_ALL/                   # 📝 所有文檔
    ├── 00_README_INDEX.md
    ├── 01_QUICK_START.md
    ├── 10_SYSTEM_OVERVIEW.md
    └── ...
```

### 核心模組說明

#### vector_store.py
- **功能**：向量化和存儲教材
- **技術**：支援本地模型（fastembed）或 OpenAI API
- **緩存**：自動保存到 vectors.pkl

#### rag_module.py
- **功能**：檢索相關教材並排序
- **方法**：餘弦相似度計算
- **緩存**：緩存查詢結果

#### scenario_classifier.py
- **功能**：K/C/R 三維度判定和情境匹配
- **技術**：整合 dimension_classifier
- **輸出**：情境編號（1-12）

#### dimension_classifier.py
- **功能**：集中管理 K/C/R 三個維度的檢測
- **並行**：C值和知識點檢測並行執行
- **本地計算**：K值和R值本地計算

#### tools/correctness_detector.py
- **功能**：C值檢測（正確性判斷）
- **技術**：OpenAI API + JSON mode

#### tools/knowledge_detector.py
- **功能**：知識點檢測
- **資料**：從 `data/ontology/knowledge_points.json` 載入節點清單
- **規則**：中文「原字串精確匹配」；不使用同義詞/英文/縮寫，不推理
- **技術**：OpenAI Function Calling
- **輸出**：知識點名稱列表

#### tools/repetition_checker.py
- **功能**：R值檢測（重複性判斷）
- **方法**：檢查前兩次歷史記錄的交集
- **特點**：自動管理歷史（deque maxlen=2）

#### ontology_manager.py
- **功能**：管理知識本體論
- **用途**：提供知識點關係說明

#### history_manager.py
- **功能**：記錄查詢歷史
- **用途**：統計分析、歷史查詢

#### timer_utils.py
- **功能**：並行計時
- **精度**：納秒級（time.perf_counter）

---

## 工作流程

### 完整處理流程

```
1. 📥 用戶輸入問題
    ↓
2. 🚀 後端接收（計時起點）
    ↓
3. ┌──────────── 並行處理 ────────────┐
   │                                  │
   │  Thread 1: RAG Embedding API     │
   │  Thread 2: C值檢測 API           │
   │  Thread 3: 知識點檢測 API        │
   │                                  │
   └──────────── 同時完成 ────────────┘
    ↓
4. 🔢 本地計算
   ├─ K值 = len(knowledge_points)
   └─ R值 = repetition_checker.check_and_update()
    ↓
5. 🎯 計算情境編號
   scenario_number = k*4 + c*2 + r + 1
    ↓
6. 🔄 整合結果
   ├─ RAG 上下文
   ├─ 情境提示詞
   └─ 知識本體論
    ↓
7. 🤖 生成最終答案（流式輸出）
    ↓
8. 📤 後端轉發（計時終點）
    ↓
9. 💻 前端渲染
    ↓
10. 👤 用戶查看結果
```

### 時間分配

| 階段 | 預期時間 | 說明 |
|------|---------|------|
| RAG Embedding | 0.2-0.5s | 向量檢索（本地模型更快） |
| C值檢測 API | 0.3-0.5s | 正確性判斷 |
| 知識點檢測 API | 0.3-0.5s | 知識點識別 |
| 並行處理 | 0.3-0.5s | max(Thread 1, 2, 3) |
| 本地計算 | <0.001s | K值和R值計算 |
| 最終生成 | 1.0-2.0s | LLM 流式輸出 |
| **總計** | **1.5-3.0s** | 端到端處理時間 |

---

## 技術特點

### 1. 高效的向量檢索

- **模型**：支援本地模型（fastembed）或 OpenAI API
- **本地模型**：BAAI/bge-small-en-v1.5（約30MB）
- **OpenAI模型**：text-embedding-3-small
- **相似度**：餘弦相似度
- **緩存**：首次向量化後保存，之後快速載入

### 2. 智能的情境匹配

- **方法**：K/C/R 三維度組合計算
- **公式**：scenario_number = k*4 + c*2 + r + 1
- **精確度**：Function Calling 保證格式正確
- **情境數**：12種情境，覆蓋所有教學場景

### 3. 優化的重複檢測

- **方法**：檢查前兩次歷史記錄的交集
- **自動管理**：使用 deque(maxlen=2)
- **效率**：O(n) 集合運算
- **特點**：一次調用完成檢查和更新

### 4. 精確的計時系統

- **工具**：time.perf_counter()
- **精度**：納秒級
- **範圍**：覆蓋所有關鍵階段
- **並行追蹤**：獨立追蹤每個執行緒

---

## 使用場景

### 場景 1：教育輔助

- **用戶**：學生、教師
- **用途**：學習教材、解答疑問
- **優勢**：自動判斷問題類型，給予適當提示

### 場景 2：知識問答

- **用戶**：研究人員、開發者
- **用途**：快速查找技術資料
- **優勢**：RAG 檢索精準，回答基於教材

### 場景 3：系統演示

- **用戶**：技術展示、演講
- **用途**：展示 RAG 和多維度分類
- **優勢**：Web 界面美觀，計時詳細

### 場景 4：研究實驗

- **用戶**：AI 研究者
- **用途**：測試不同的分類策略
- **優勢**：開源、可自定義、有詳細日誌

---

## 🎯 快速開始

```bash
# 1. 安裝依賴
pip3 install --user -r requirements.txt

# 2. 設定 API Key
export OPENAI_API_KEY="your-key"

# 3. 運行系統
python3 main_parallel.py

# 或啟動 Web 界面
python3 web_api.py
open web/index.html
```

---

## 📖 相關文檔

- **快速開始**: [01_QUICK_START.md](01_QUICK_START.md)
- **安裝指南**: [02_INSTALLATION.md](02_INSTALLATION.md)
- **計時系統**: [12_DUAL_THREAD_TIMING.md](12_DUAL_THREAD_TIMING.md)
- **主要說明**: 查看根目錄的 `README.md`
- **源代碼**: 查看 `core/` 目錄和 `main_parallel.py`

---

**這就是 RAG 流式系統的完整概述！** 🎉
