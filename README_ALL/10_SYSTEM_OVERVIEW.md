# 系統完整概述

**📅 更新日期**: 2025-10-08  
**🔧 系統版本**: 2.0（雙線程計時版本）

---

## 📋 目錄

1. [系統簡介](#系統簡介)
2. [核心功能](#核心功能)
3. [系統架構](#系統架構)
4. [工作流程](#工作流程)
5. [技術特點](#技術特點)
6. [使用場景](#使用場景)

---

## 系統簡介

### 什麼是 RAG 流式系統？

**RAG（Retrieval-Augmented Generation）流式系統**是一個智能問答系統，結合了：

- **向量檢索**：快速找到相關教材
- **四向度分類**：分析問題的多個維度
- **情境匹配**：根據分類結果匹配24種情境
- **並行處理**：雙線程同時執行，提升效率
- **精確計時**：獨立追蹤每個階段的執行時間

### 系統特色

✨ **智能分類**：自動判斷問題涉及的知識點數量、表達錯誤、詳細度、重複狀態  
🚀 **並行處理**：RAG 檢索和情境判定同時進行，節省 50% 時間  
📊 **精確計時**：Thread A 和 Thread B 獨立計時，清楚了解每個階段耗時  
🎯 **24種情境**：3×2×2×2 的組合，覆蓋所有可能情況  
🌐 **Web 界面**：美觀的互動式界面，易於使用

---

## 核心功能

### 1. 四向度分類系統

| 向度 | 名稱 | 判斷方式 | 可能值 |
|------|------|----------|--------|
| **D1** | 知識點數量 | RAG 實際匹配 | 零個、一個、多個 |
| **D2** | 表達錯誤 | AI 判斷 | 有錯誤、無錯誤 |
| **D3** | 表達詳細度 | AI 判斷 | 粗略、非常詳細 |
| **D4** | 重複詢問 | AI 分析歷史 | 重複狀態、正常狀態 |

#### D1 - 知識點數量

**判斷邏輯**：根據 RAG 檢索結果

- **零個**：沒有匹配到任何教材（如："你好"、"天氣如何"）
- **一個**：匹配到單一知識點（如："什麼是機器學習？"）
- **多個**：匹配到多個知識點（如："機器學習和深度學習的區別？"）

#### D2 - 表達錯誤

**判斷邏輯**：AI 分析問題的語法和邏輯

- **有錯誤**：概念混淆、語法錯誤（如："機器學習是不是就是深度學習？"）
- **無錯誤**：表達清晰正確

#### D3 - 表達詳細度

**判斷邏輯**：AI 分析問題的完整性

- **粗略**：簡單問題（如："ML是什麼？"）
- **非常詳細**：詳細問題（如："請詳細解釋機器學習的工作原理，包括訓練過程"）

#### D4 - 重複詢問

**判斷邏輯**：AI 分析歷史記錄

- **重複狀態**：連續多次問相似問題
- **正常狀態**：首次或不重複的問題

### 2. 24種情境組合

3（D1）× 2（D2）× 2（D3）× 2（D4）= **24 種情境**

每種情境都有對應的回答策略和提示詞模板。

**情境範例**：

| 情境 | D1 | D2 | D3 | D4 | 說明 |
|------|----|----|----|----|------|
| 情境 1 | 零個 | 有錯誤 | 粗略 | 重複狀態 | 可能需要引導用戶重新提問 |
| 情境 8 | 一個 | 無錯誤 | 粗略 | 正常狀態 | 最常見的基礎問題 |
| 情境 16 | 一個 | 無錯誤 | 非常詳細 | 正常狀態 | 深入理解的問題 |
| 情境 22 | 多個 | 無錯誤 | 粗略 | 正常狀態 | 比較類問題 |

### 3. 並行處理架構

**雙線程設計**：

```
用戶問題
    ↓
┌───────────────────────────────────┐
│    並行處理（同時執行）           │
│                                   │
│  Thread A (主線)   Thread B (分支)│
│  ├─ RAG檢索        ├─ 獲取歷史   │
│  └─ 草稿生成       └─ 四向度判定 │
│                                   │
│  耗時: 3.357s      耗時: 3.433s  │
└───────────────────────────────────┘
    ↓
會診合併（整合結果）
    ↓
生成最終答案
```

**效率提升**：
- 串行總時間：3.357 + 3.433 = 6.790s
- 並行實際時間：3.456s（約等於較長的那個）
- **效率提升**：約 49%

### 4. 雙線程計時系統

**獨立追蹤**：

- **Thread A 計時**：RAG檢索、草稿生成
- **Thread B 計時**：獲取歷史、四向度判定
- **主流程計時**：並行處理、會診合併、總流程

**輸出範例**：
```
======================================================================
⏱️  時間分析報告（雙線程）
======================================================================

【主流程】
  總流程                          :  5.234s
  並行處理（總時間）              :  3.456s
  會診合併                        :  1.234s

【Thread A (RAG)】
  RAG檢索                         :  1.234s
  草稿生成                        :  2.123s
  Thread A 小計                   :  3.357s

【Thread B (Scenario)】
  獲取歷史                        :  0.012s
  四向度判定                      :  3.421s
  Thread B 小計                   :  3.433s

----------------------------------------------------------------------
  總計（從後端接收到渲染完成）    :  5.234s
======================================================================
```

---

## 系統架構

### 文件結構

```
test_Time_RAG_stream/
├── main_parallel.py              # 主程序（雙線程版本）
├── web_api.py                    # Web API 後端
├── config.py                     # 系統配置
├── requirements.txt              # 依賴列表
│
├── core/                         # 核心模組
│   ├── __init__.py
│   ├── vector_store.py           # 向量存儲（OpenAI Embeddings）
│   ├── rag_module.py             # RAG 檢索與緩存
│   ├── scenario_classifier.py   # 情境分類器（24種）
│   ├── ontology_manager.py       # 本體論管理
│   ├── history_manager.py        # 歷史記錄管理
│   └── timer_utils.py            # 雙線程計時工具
│
├── data/                         # 數據目錄
│   ├── docs/                     # 教材文件
│   │   ├── ml_basics.txt
│   │   ├── deep_learning.txt
│   │   └── nlp_intro.txt
│   ├── scenarios/                # 情境配置
│   │   └── scenarios_24.json
│   └── ontology/                 # 知識本體論
│       └── knowledge_ontology.txt
│
├── web/                          # Web 前端
│   ├── index.html                # 主界面
│   ├── app.js                    # JavaScript 邏輯
│   ├── interactive.html          # 互動式界面
│   └── old_interface.html        # 舊版界面（備份）
│
├── tests/                        # 測試文件
│   ├── test_system.py
│   └── test_d4_logic.py
│
├── scripts/                      # 工具腳本
│   ├── run_test.py
│   └── scenario_generator.py
│
└── README_ALL/                   # 📝 所有文檔
    ├── 01_QUICK_START.md
    ├── 10_SYSTEM_OVERVIEW.md
    └── ...
```

### 核心模組說明

#### vector_store.py
- **功能**：向量化和存儲教材
- **技術**：OpenAI text-embedding-ada-002
- **緩存**：自動保存到 vectors.pkl

#### rag_module.py
- **功能**：檢索相關教材並排序
- **方法**：餘弦相似度計算
- **緩存**：緩存查詢結果

#### scenario_classifier.py
- **功能**：四向度判定和情境匹配
- **技術**：OpenAI Function Calling
- **輸出**：情境編號（1-24）

#### ontology_manager.py
- **功能**：管理知識本體論
- **用途**：提供知識點關係說明

#### history_manager.py
- **功能**：記錄查詢歷史
- **用途**：支持 D4 重複判定

#### timer_utils.py
- **功能**：雙線程計時
- **精度**：納秒級（time.perf_counter）

---

## 工作流程

### 完整處理流程

```
1. 📥 用戶輸入問題
    ↓
2. 🚀 後端接收（計時起點）
    ↓
3. ┌──────────── 並行處理 ────────────┐
   │                                  │
   │  Thread A (主線)  Thread B (分支)│
   │  ├─ 向量檢索      ├─ 讀取歷史   │
   │  ├─ 匹配教材      ├─ 分析四向度 │
   │  ├─ 提取知識點    ├─ 呼叫 API   │
   │  └─ 生成草稿      └─ 返回情境   │
   │                                  │
   └──────────── 同時完成 ────────────┘
    ↓
4. 🔄 會診合併
   ├─ 整合草稿答案
   ├─ 加入情境資訊
   └─ 載入本體論
    ↓
5. 🤖 生成最終答案（LLM）
    ↓
6. 📤 後端轉發（計時終點）
    ↓
7. 💻 前端渲染
    ↓
8. 👤 用戶查看結果
```

### 時間分配

| 階段 | 預期時間 | 說明 |
|------|---------|------|
| 向量檢索 | 0.5-1.5s | RAG 檢索相關文檔 |
| 草稿生成 | 1.5-3.0s | LLM 生成初步答案 |
| 獲取歷史 | 0.01-0.05s | 本地文件讀取 |
| 四向度判定 | 2.0-4.0s | LLM API 判定 |
| 並行處理 | 3.0-4.0s | max(Thread A, Thread B) |
| 會診合併 | 1.0-2.0s | 整合並生成最終答案 |
| **總計** | **4.0-7.0s** | 端到端處理時間 |

---

## 技術特點

### 1. 高效的向量檢索

- **模型**：OpenAI text-embedding-ada-002
- **維度**：1536
- **相似度**：餘弦相似度
- **緩存**：首次向量化後保存，之後快速載入

### 2. 智能的情境匹配

- **方法**：O(1) 哈希查找
- **精確度**：Function Calling 保證格式正確
- **可擴展**：易於添加新情境

### 3. 穩定的歷史管理

- **存儲**：JSON 格式
- **容量**：保留最近 10 筆
- **用途**：D4 重複判定、統計分析

### 4. 精確的計時系統

- **工具**：time.perf_counter()
- **精度**：納秒級
- **範圍**：覆蓋所有關鍵階段

---

## 使用場景

### 場景 1：教育輔助

- **用戶**：學生、教師
- **用途**：學習教材、解答疑問
- **優勢**：自動判斷問題類型，給予適當提示

### 場景 2：知識問答

- **用戶**：研究人員、開發者
- **用途**：快速查找技術資料
- **優勢**：RAG 檢索精準，回答基於教材

### 場景 3：系統演示

- **用戶**：技術展示、演講
- **用途**：展示 RAG 和多維度分類
- **優勢**：Web 界面美觀，計時詳細

### 場景 4：研究實驗

- **用戶**：AI 研究者
- **用途**：測試不同的分類策略
- **優勢**：開源、可自定義、有詳細日誌

---

## 🎯 快速開始

```bash
# 1. 安裝依賴
pip3 install --user -r requirements.txt

# 2. 設定 API Key
export OPENAI_API_KEY="your-key"

# 3. 運行系統
python3 main_parallel.py

# 或啟動 Web 界面
python3 web_api.py
open web/index.html
```

---

## 📖 相關文檔

- **快速開始**: [01_QUICK_START.md](01_QUICK_START.md)
- **安裝指南**: [02_INSTALLATION.md](02_INSTALLATION.md)
- **架構詳解**: [11_ARCHITECTURE.md](11_ARCHITECTURE.md)
- **計時系統**: [12_DUAL_THREAD_TIMING.md](12_DUAL_THREAD_TIMING.md)
- **命令參考**: [20_COMMAND_REFERENCE.md](20_COMMAND_REFERENCE.md)

---

**這就是 RAG 流式系統的完整概述！** 🎉
