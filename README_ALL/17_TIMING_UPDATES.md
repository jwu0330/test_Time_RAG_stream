# æ™‚é–“è¨˜éŒ„ç³»çµ±æ›´æ–°èªªæ˜

**ğŸ“… æ›´æ–°æ—¥æœŸ**: 2025-10-08  
**ğŸ“š ç‰ˆæœ¬**: 2.0 - Responses API é›™å›åˆæ¶æ§‹

---

## ğŸ¯ æ›´æ–°æ¦‚è¿°

é…åˆ Responses API é›™å›åˆæ¶æ§‹ï¼Œæ‰€æœ‰æ™‚é–“è¨˜éŒ„ç›¸é—œçš„åç¨±å’Œé¡¯ç¤ºéƒ½å·²æ›´æ–°ï¼Œä»¥æº–ç¢ºåæ˜ æ–°çš„è™•ç†æµç¨‹ã€‚

---

## ğŸ“Š ä¸»è¦æ›´æ–°

### 1. **æ ¸å¿ƒæ¨¡çµ„ï¼š`core/timer_utils.py`**

#### æ›´æ–°å‰ï¼ˆèˆŠç‰ˆï¼‰
```python
"""
æ™‚é–“æ¸¬é‡å·¥å…·æ¨¡çµ„
æ”¯æ´é›™ç·šç¨‹ï¼ˆThread A: RAG, Thread B: Scenarioï¼‰ç¨ç«‹è¨ˆæ™‚
"""

class Timer:
    """è¨ˆæ™‚å™¨ç®¡ç†é¡ - æ”¯æ´é›™ç·šç¨‹ç¨ç«‹è¨ˆæ™‚"""
    
    def __init__(self):
        self.thread_a_records = {}  # Thread A (RAG)
        self.thread_b_records = {}  # Thread B (Scenario)
```

#### æ›´æ–°å¾Œï¼ˆæ–°ç‰ˆï¼‰
```python
"""
æ™‚é–“æ¸¬é‡å·¥å…·æ¨¡çµ„
æ”¯æ´é›™å›åˆä¸¦è¡Œè™•ç†ï¼ˆThread A: RAG æª¢ç´¢, Thread B: Responses API æƒ…å¢ƒåˆ¤å®šï¼‰ç¨ç«‹è¨ˆæ™‚
"""

class Timer:
    """è¨ˆæ™‚å™¨ç®¡ç†é¡ - æ”¯æ´é›™å›åˆä¸¦è¡Œè™•ç†ç¨ç«‹è¨ˆæ™‚"""
    
    def __init__(self):
        self.thread_a_records = {}  # Thread A (RAG æª¢ç´¢)
        self.thread_b_records = {}  # Thread B (Responses API æƒ…å¢ƒåˆ¤å®š)
```

### 2. **ç·šç¨‹åç¨±æ›´æ–°**

#### Thread Aï¼ˆä¸»ç·šï¼‰
- **èˆŠç‰ˆ**: `"Thread A (RAG)"`
- **æ–°ç‰ˆ**: `"Thread A - ä¸»ç·šï¼ˆRAG æª¢ç´¢ï¼‰"`

#### Thread Bï¼ˆæ”¯ç·šï¼‰
- **èˆŠç‰ˆ**: `"Thread B (Scenario)"`
- **æ–°ç‰ˆ**: `"Thread B - æ”¯ç·šï¼ˆResponses API æƒ…å¢ƒåˆ¤å®šï¼‰"`

### 3. **å ±å‘Šæ¨™é¡Œæ›´æ–°**

#### æ§åˆ¶å°è¼¸å‡º
```python
# èˆŠç‰ˆ
print("â±ï¸  æ™‚é–“åˆ†æå ±å‘Šï¼ˆé›™ç·šç¨‹ï¼‰")

# æ–°ç‰ˆ
print("â±ï¸  æ™‚é–“åˆ†æå ±å‘Šï¼ˆResponses API é›™å›åˆä¸¦è¡Œè™•ç†ï¼‰")
```

### 4. **ä¸»ç¨‹åºï¼š`main_parallel.py`**

#### çµæœæ‘˜è¦æ¨™é¡Œ
```python
# èˆŠç‰ˆ
print("ğŸ“Š è™•ç†çµæœæ‘˜è¦")

# æ–°ç‰ˆ
print("ğŸ“Š Responses API é›™å›åˆè™•ç†çµæœæ‘˜è¦")
```

#### æ™‚é–“é¡¯ç¤ºæ ¼å¼å„ªåŒ–
```python
# æ–°ç‰ˆä½¿ç”¨æ¨¹ç‹€çµæ§‹é¡¯ç¤º
print("  â”Œâ”€ ã€ä¸»æµç¨‹ - ç¸½é«”æ™‚é–“ã€‘")
print(f"  â”‚   {stage:30s}: {duration:6.3f}s")
print(f"  â”œâ”€ ã€Thread A - ä¸»ç·šï¼ˆRAG æª¢ç´¢ï¼‰ã€‘")
print(f"  â”‚   {stage:30s}: {duration:6.3f}s")
print(f"  â””â”€ ã€Thread B - æ”¯ç·šï¼ˆResponses API æƒ…å¢ƒåˆ¤å®šï¼‰ã€‘")
print(f"      {stage:30s}: {duration:6.3f}s")
```

### 5. **Web APIï¼š`web_api.py`**

#### API ç«¯é»è¨»é‡‹
```python
# èˆŠç‰ˆ
"""
è™•ç†æŸ¥è©¢è«‹æ±‚ - æ‰€æœ‰è¨ˆæ™‚åœ¨å¾Œç«¯é€²è¡Œ
å¾å¾Œç«¯æ¥æ”¶æ–‡å­—é–‹å§‹è¨ˆæ™‚ï¼Œåˆ°è½‰ç™¼å‡ºå»ç‚ºæ­¢
"""

# æ–°ç‰ˆ
"""
è™•ç†æŸ¥è©¢è«‹æ±‚ - Responses API é›™å›åˆæµç¨‹
æ‰€æœ‰è¨ˆæ™‚åœ¨å¾Œç«¯é€²è¡Œï¼Œå¾æ¥æ”¶åˆ°è½‰ç™¼å®Œæˆ
"""
```

#### æ—¥èªŒè¼¸å‡º
```python
# èˆŠç‰ˆ
print(f"â±ï¸  é–‹å§‹è¨ˆæ™‚...")
print(f"â±ï¸  å¾Œç«¯ç¸½è™•ç†æ™‚é–“: {backend_total_time:.3f}s")

# æ–°ç‰ˆ
print(f"â±ï¸  é–‹å§‹ Responses API é›™å›åˆè™•ç†...")
print(f"â±ï¸  Responses API é›™å›åˆç¸½è™•ç†æ™‚é–“: {backend_total_time:.3f}s")
```

---

## ğŸ“ˆ æ™‚é–“å ±å‘Šç¤ºä¾‹

### æ–°ç‰ˆè¼¸å‡ºæ ¼å¼

```
======================================================================
â±ï¸  æ™‚é–“åˆ†æå ±å‘Šï¼ˆResponses API é›™å›åˆä¸¦è¡Œè™•ç†ï¼‰
======================================================================

ã€ä¸»æµç¨‹ - ç¸½é«”æ™‚é–“ã€‘
  å‘é‡åŒ–                              :  0.123s
  ä¸¦è¡Œè™•ç†ï¼ˆç¸½æ™‚é–“ï¼‰                  :  2.456s
  æœ€çµ‚å›åˆç”Ÿæˆ                        :  3.789s
  ç¸½æµç¨‹                              :  6.368s

ã€Thread A - ä¸»ç·šï¼ˆRAG æª¢ç´¢ï¼‰ã€‘
  RAGæª¢ç´¢                             :  2.123s
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  ä¸»ç·šå°è¨ˆ                            :  2.123s

ã€Thread B - æ”¯ç·šï¼ˆResponses API æƒ…å¢ƒåˆ¤å®šï¼‰ã€‘
  ç²å–æ­·å²                            :  0.012s
  æƒ…å¢ƒåˆ¤å®šï¼ˆResponses APIï¼‰           :  0.345s
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  æ”¯ç·šå°è¨ˆ                            :  0.357s

======================================================================
  ğŸ¯ ç¸½è¨ˆæ™‚é–“                         :  6.368s
======================================================================
```

### çµæœæ‘˜è¦è¼¸å‡ºæ ¼å¼

```
======================================================================
ğŸ“Š Responses API é›™å›åˆè™•ç†çµæœæ‘˜è¦
======================================================================
æŸ¥è©¢ï¼šä»€éº¼æ˜¯æ©Ÿå™¨å­¸ç¿’ï¼Ÿ

ğŸ¯ æƒ…å¢ƒåˆ¤å®šï¼šç¬¬ 14 ç¨®æƒ…å¢ƒ
   æè¿°ï¼šä¸€å€‹ + ç„¡éŒ¯èª¤ + ç²—ç•¥ + æ­£å¸¸ç‹€æ…‹

ğŸ“ å››å‘åº¦åˆ†æï¼š
   D1: ä¸€å€‹
   D2: ç„¡éŒ¯èª¤
   D3: ç²—ç•¥
   D4: æ­£å¸¸ç‹€æ…‹

ğŸ“š åŒ¹é…çŸ¥è­˜é»ï¼šæ©Ÿå™¨å­¸ç¿’åŸºç¤

â±ï¸  åŸ·è¡Œæ™‚é–“åˆ†æï¼š
  â”Œâ”€ ã€ä¸»æµç¨‹ - ç¸½é«”æ™‚é–“ã€‘
  â”‚   å‘é‡åŒ–                        :  0.123s
  â”‚   ä¸¦è¡Œè™•ç†ï¼ˆç¸½æ™‚é–“ï¼‰            :  2.456s
  â”‚   æœ€çµ‚å›åˆç”Ÿæˆ                  :  3.789s
  â”œâ”€ ã€Thread A - ä¸»ç·šï¼ˆRAG æª¢ç´¢ï¼‰ã€‘
  â”‚   RAGæª¢ç´¢                       :  2.123s
  â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  â”‚   ä¸»ç·šå°è¨ˆ                      :  2.123s
  â””â”€ ã€Thread B - æ”¯ç·šï¼ˆResponses API æƒ…å¢ƒåˆ¤å®šï¼‰ã€‘
      ç²å–æ­·å²                      :  0.012s
      æƒ…å¢ƒåˆ¤å®šï¼ˆResponses APIï¼‰     :  0.345s
      â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      æ”¯ç·šå°è¨ˆ                      :  0.357s

  ğŸ¯ ç¸½è¨ˆæ™‚é–“: 6.368s
======================================================================
```

---

## ğŸ”„ è™•ç†æµç¨‹æ™‚é–“åˆ†è§£

### ç¬¬ä¸€å›åˆï¼šä¸¦è¡Œè™•ç†

```
é–‹å§‹æ™‚é–“: T0
â”œâ”€ Thread Aï¼ˆä¸»ç·šï¼‰: RAG æª¢ç´¢
â”‚  â”œâ”€ å‘é‡æª¢ç´¢: T0 â†’ T1 (2.123s)
â”‚  â””â”€ å®Œæˆ
â”‚
â””â”€ Thread Bï¼ˆæ”¯ç·šï¼‰: Responses API æƒ…å¢ƒåˆ¤å®š
   â”œâ”€ ç²å–æ­·å²: T0 â†’ T0.1 (0.012s)
   â”œâ”€ Function Call: T0.1 â†’ T0.4 (0.345s)
   â””â”€ å®Œæˆ

ä¸¦è¡Œç¸½æ™‚é–“: max(2.123s, 0.357s) = 2.456s
```

### ç¬¬äºŒå›åˆï¼šæœ€çµ‚ç”Ÿæˆ

```
é–‹å§‹æ™‚é–“: T1
â”œâ”€ æ•´åˆè³‡è¨Šï¼ˆRAG + æƒ…å¢ƒ + æœ¬é«”è«–ï¼‰
â”œâ”€ æ§‹å»ºæç¤ºè©
â”œâ”€ Responses API æµå¼ç”Ÿæˆ
â””â”€ å®Œæˆ: T1 â†’ T2 (3.789s)
```

### ç¸½è¨ˆæ™‚é–“

```
ç¸½æ™‚é–“ = å‘é‡åŒ– + ä¸¦è¡Œè™•ç† + æœ€çµ‚ç”Ÿæˆ
      = 0.123s + 2.456s + 3.789s
      = 6.368s
```

---

## ğŸ“ æ•¸æ“šçµæ§‹

### TimerReport çµæ§‹

```python
{
    "timestamp": "2025-10-08T21:45:00",
    "stages": {
        "å‘é‡åŒ–": 0.123,
        "ä¸¦è¡Œè™•ç†ï¼ˆç¸½æ™‚é–“ï¼‰": 2.456,
        "æœ€çµ‚å›åˆç”Ÿæˆ": 3.789,
        "ç¸½æµç¨‹": 6.368
    },
    "thread_a": {
        "thread_name": "Thread A - ä¸»ç·šï¼ˆRAG æª¢ç´¢ï¼‰",
        "stages": {
            "RAGæª¢ç´¢": 2.123
        },
        "total_time": 2.123
    },
    "thread_b": {
        "thread_name": "Thread B - æ”¯ç·šï¼ˆResponses API æƒ…å¢ƒåˆ¤å®šï¼‰",
        "stages": {
            "ç²å–æ­·å²": 0.012,
            "æƒ…å¢ƒåˆ¤å®šï¼ˆResponses APIï¼‰": 0.345
        },
        "total_time": 0.357
    },
    "total_time": 6.368
}
```

---

## ğŸ¯ é—œéµæ”¹é€²

### 1. **åç¨±æº–ç¢ºæ€§**
- âœ… æ‰€æœ‰åç¨±åæ˜ å¯¦éš›çš„ Responses API æ¶æ§‹
- âœ… æ¸…æ¥šå€åˆ†ã€ŒRAG æª¢ç´¢ã€å’Œã€ŒResponses API æƒ…å¢ƒåˆ¤å®šã€
- âœ… ä½¿ç”¨ã€Œé›™å›åˆã€è€Œéã€Œé›™ç·šç¨‹ã€æè¿°æµç¨‹

### 2. **é¡¯ç¤ºæ¸…æ™°åº¦**
- âœ… ä½¿ç”¨æ¨¹ç‹€çµæ§‹é¡¯ç¤ºæ™‚é–“å±¤æ¬¡
- âœ… æ·»åŠ è¦–è¦ºåˆ†éš”ç·š
- âœ… ä½¿ç”¨ emoji åœ–æ¨™å¢å¼·å¯è®€æ€§

### 3. **ä¿¡æ¯å®Œæ•´æ€§**
- âœ… åŒ…å«æ‰€æœ‰éšæ®µçš„è©³ç´°æ™‚é–“
- âœ… é¡¯ç¤ºä¸¦è¡Œè™•ç†çš„æ•ˆç‡
- âœ… æä¾›ç¸½è¨ˆæ™‚é–“å’Œå„ç·šç¨‹å°è¨ˆ

---

## ğŸ” ä½¿ç”¨ç¤ºä¾‹

### æŸ¥çœ‹æ™‚é–“å ±å‘Š

```python
# åœ¨ä»£ç¢¼ä¸­
system = ResponsesRAGSystem()
result = await system.process_query("ä»€éº¼æ˜¯æ©Ÿå™¨å­¸ç¿’ï¼Ÿ")

# è‡ªå‹•æ‰“å°è©³ç´°å ±å‘Š
system.print_summary(result)

# æˆ–ç²å– JSON æ ¼å¼
time_report = result['time_report']
print(json.dumps(time_report, indent=2, ensure_ascii=False))
```

### Web API éŸ¿æ‡‰

```json
{
  "answer": "...",
  "scenario_number": 14,
  "timing_details": {
    "backend_total": 6.368,
    "stages": {...},
    "thread_a": {
      "thread_name": "Thread A - ä¸»ç·šï¼ˆRAG æª¢ç´¢ï¼‰",
      "stages": {...},
      "total_time": 2.123
    },
    "thread_b": {
      "thread_name": "Thread B - æ”¯ç·šï¼ˆResponses API æƒ…å¢ƒåˆ¤å®šï¼‰",
      "stages": {...},
      "total_time": 0.357
    },
    "timestamp": "2025-10-08T21:45:00"
  }
}
```

---

## ğŸ“š ç›¸é—œæ–‡æª”

- [Responses API æ¶æ§‹èªªæ˜](13_RESPONSES_API_ARCHITECTURE.md)
- [é›™ç·šç¨‹è¨ˆæ™‚ç³»çµ±](12_DUAL_THREAD_TIMING.md)ï¼ˆèˆŠç‰ˆåƒè€ƒï¼‰
- [è¨­ç½®ç¸½çµ](15_SETUP_SUMMARY.md)

---

## âœ… æ›´æ–°æª¢æŸ¥æ¸…å–®

- [x] `core/timer_utils.py` - æ›´æ–°æ‰€æœ‰åç¨±å’Œè¨»é‡‹
- [x] `main_parallel.py` - æ›´æ–° print_summary é¡¯ç¤ºæ ¼å¼
- [x] `web_api.py` - æ›´æ–° API è¨»é‡‹å’Œæ—¥èªŒè¼¸å‡º
- [x] æ™‚é–“å ±å‘Šæ¨™é¡Œåæ˜ ã€ŒResponses API é›™å›åˆã€
- [x] Thread åç¨±æ¸…æ¥šèªªæ˜åŠŸèƒ½
- [x] é¡¯ç¤ºæ ¼å¼å„ªåŒ–ï¼ˆæ¨¹ç‹€çµæ§‹ï¼‰

---

**æ‰€æœ‰æ™‚é–“è¨˜éŒ„å·²æ›´æ–°å®Œæˆï¼Œæº–ç¢ºåæ˜  Responses API é›™å›åˆæ¶æ§‹ï¼** â±ï¸âœ¨
