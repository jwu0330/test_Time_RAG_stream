# ä¸‰å€‹ API + æœ¬åœ°è¨ˆç®—æž¶æ§‹

**ðŸ“… æ›´æ–°æ—¥æœŸ**: 2025-01-09  
**ðŸ“š ç‰ˆæœ¬**: 3.0 - ç°¡åŒ–ç‰ˆæœ¬

---

## ðŸŽ¯ æž¶æ§‹æ¦‚è¿°

### å¾žå››å€‹ API åˆ°ä¸‰å€‹ API

**èˆŠç‰ˆï¼ˆ4å€‹ APIï¼‰**ï¼š
- D1 API - çŸ¥è­˜é»žæ•¸é‡åˆ¤å®š
- D2 API - è¡¨é”éŒ¯èª¤åˆ¤å®š
- D3 API - è¡¨é”è©³ç´°åº¦åˆ¤å®š
- D4 æœ¬åœ°é‚è¼¯ - é‡è¤‡åˆ¤å®š

**æ–°ç‰ˆï¼ˆ3å€‹ API + æœ¬åœ°è¨ˆç®—ï¼‰**ï¼š
- D2 API - è¡¨é”éŒ¯èª¤åˆ¤å®š
- D3 API - è¡¨é”è©³ç´°åº¦åˆ¤å®š
- D4 API - **çŸ¥è­˜é»žæª¢æ¸¬**ï¼ˆè¿”å›žäºŒé€²åˆ¶ç·¨ç¢¼ï¼‰
- D1 æœ¬åœ°è¨ˆç®— - å¾ž D4 çš„äºŒé€²åˆ¶ç·¨ç¢¼è¨ˆç®—çŸ¥è­˜é»žæ•¸é‡
- D4 æœ¬åœ°åˆ¤å®š - å¾žæ­·å²æª¢æŸ¥é‡è¤‡

---

## ðŸ“Š ä¸‰å€‹ API è¨­è¨ˆ

### 1. D2 API - è¡¨é”éŒ¯èª¤åˆ¤å®š

**è¼¸å…¥**: ç•¶å‰å•é¡Œ  
**è¼¸å‡º**: `0` (ç„¡éŒ¯èª¤) æˆ– `1` (æœ‰éŒ¯èª¤)  
**éœ€è¦æ­·å²**: âŒ å¦

```python
async def classify_d2_has_error(query: str) -> int:
    # åˆ¤å®šå•é¡Œæ˜¯å¦æœ‰éŒ¯èª¤æˆ–çŸ›ç›¾
    return 0 or 1
```

### 2. D3 API - è¡¨é”è©³ç´°åº¦åˆ¤å®š

**è¼¸å…¥**: ç•¶å‰å•é¡Œ  
**è¼¸å‡º**: `0` (ç²—ç•¥) æˆ– `1` (éžå¸¸è©³ç´°)  
**éœ€è¦æ­·å²**: âŒ å¦

```python
async def classify_d3_detail_level(query: str) -> int:
    # åˆ¤å®šå•é¡Œçš„è©³ç´°ç¨‹åº¦
    return 0 or 1
```

### 3. D4 API - çŸ¥è­˜é»žæª¢æ¸¬

**è¼¸å…¥**: ç•¶å‰å•é¡Œ  
**è¼¸å‡º**: äºŒé€²åˆ¶å­—ç¬¦ä¸²ï¼ˆä¾‹å¦‚ `"1011"`ï¼‰  
**éœ€è¦æ­·å²**: âŒ å¦

```python
async def classify_d4_knowledge_detection(query: str) -> str:
    # åˆ¤å®šç•¶å‰å•é¡Œè§¸åŠäº†å“ªäº›çŸ¥è­˜é»ž
    # è¿”å›žäºŒé€²åˆ¶ç·¨ç¢¼ï¼Œä¾‹å¦‚ "1011" è¡¨ç¤ºè§¸åŠç¬¬0,2,3å€‹çŸ¥è­˜é»ž
    return "1011"
```

**äºŒé€²åˆ¶ç·¨ç¢¼èªªæ˜Ž**ï¼š
- ä½ç½® 0: æ©Ÿå™¨å­¸ç¿’åŸºç¤Ž
- ä½ç½® 1: æ·±åº¦å­¸ç¿’
- ä½ç½® 2: è‡ªç„¶èªžè¨€è™•ç†
- ä½ç½® 3: ä¿ç•™

---

## ðŸ”§ æœ¬åœ°è¨ˆç®—

### D1 - çŸ¥è­˜é»žæ•¸é‡è¨ˆç®—

**è¼¸å…¥**: D4 API è¿”å›žçš„äºŒé€²åˆ¶ç·¨ç¢¼  
**è¼¸å‡º**: `0` (é›¶å€‹), `1` (ä¸€å€‹), `2` (å¤šå€‹)  
**è¨ˆç®—æ–¹å¼**: è¨ˆç®—äºŒé€²åˆ¶ä¸­ `1` çš„å€‹æ•¸

```python
def calculate_d1(binary: str) -> int:
    count = binary.count('1')
    if count == 0:
        return 0  # é›¶å€‹
    elif count == 1:
        return 1  # ä¸€å€‹
    else:
        return 2  # å¤šå€‹ (>= 2)
```

**ç¤ºä¾‹**ï¼š
- `"1011"` â†’ count = 3 â†’ D1 = 2 (å¤šå€‹)
- `"1000"` â†’ count = 1 â†’ D1 = 1 (ä¸€å€‹)
- `"0000"` â†’ count = 0 â†’ D1 = 0 (é›¶å€‹)

### D4 - é‡è¤‡åˆ¤å®šï¼ˆå„ªåŒ–ç‰ˆï¼‰

**è¼¸å…¥**: 
- ç•¶å‰äºŒé€²åˆ¶ç·¨ç¢¼ï¼ˆå¾ž D4 API ç²å¾—ï¼‰
- æ­·å²äºŒé€²åˆ¶ç·¨ç¢¼åˆ—è¡¨

**è¼¸å‡º**: `0` (æ­£å¸¸) æˆ– `1` (é‡è¤‡)

**å„ªåŒ–é‚è¼¯**ï¼š
åªæª¢æŸ¥ç•¶å‰è§¸åŠçš„çŸ¥è­˜é»žï¼ˆå€¼ç‚º `1` çš„ä½ç½®ï¼‰æ˜¯å¦åœ¨æ­·å²ä¸­ä¹Ÿé€£çºŒç‚º `1`

```python
def classify_d4_repetition(current_binary: str, history_binaries: list) -> int:
    if len(history_binaries) < 2:
        return 0
    
    recent_2 = history_binaries[-2:]
    
    # åªæª¢æŸ¥ç•¶å‰ç‚º "1" çš„ä½ç½®
    for pos in range(len(current_binary)):
        if current_binary[pos] == '1':
            # æª¢æŸ¥é€™å€‹ä½ç½®åœ¨æ­·å²æœ€è¿‘2ç­†æ˜¯å¦ä¹Ÿéƒ½ç‚º "1"
            if all(history[pos] == '1' for history in recent_2):
                return 1  # è©²ä½ç½®é€£çºŒ3æ¬¡ç‚º "1"
    
    return 0
```

**ç¤ºä¾‹**ï¼š
```
ç•¶å‰: "1011" (ç¬¬0,2,3ä½ç‚º1)
æ­·å²: ["1010", "1001"]

æª¢æŸ¥ï¼š
- ç¬¬0ä½: ç•¶å‰=1, æ­·å²=[1,1] â†’ é€£çºŒ3æ¬¡ç‚º1 âœ“ é‡è¤‡ï¼
- ç¬¬2ä½: ç•¶å‰=1, æ­·å²=[1,0] â†’ ä¸é€£çºŒ
- ç¬¬3ä½: ç•¶å‰=1, æ­·å²=[0,1] â†’ ä¸é€£çºŒ

çµæžœ: D4=1 (é‡è¤‡)
```

---

## ðŸš€ åŸ·è¡Œæµç¨‹

### ä¸¦è¡ŒåŸ·è¡Œï¼ˆ3å€‹ APIï¼‰

```python
# ä¸¦è¡Œèª¿ç”¨ D2, D3, D4 API
results = await asyncio.gather(
    classify_d2_has_error(query),
    classify_d3_detail_level(query),
    classify_d4_knowledge_detection(query)
)

d2 = results[0]  # 0/1
d3 = results[1]  # 0/1
current_binary = results[2]  # "1011"
```

### æœ¬åœ°è¨ˆç®—

```python
# D1: å¾ž D4 çš„äºŒé€²åˆ¶ç·¨ç¢¼è¨ˆç®—
count = count_knowledge_points(current_binary)
d1 = 0 if count == 0 else 1 if count == 1 else 2

# D4 é‡è¤‡åˆ¤å®š: æª¢æŸ¥æ­·å²
d4 = classify_d4_repetition(current_binary, history_binaries)
```

### å®Œæ•´çµæžœ

```python
{
    "D1": d1,                    # 0/1/2 (æœ¬åœ°è¨ˆç®—)
    "D2": d2,                    # 0/1 (API)
    "D3": d3,                    # 0/1 (API)
    "D4": d4,                    # 0/1 (æœ¬åœ°åˆ¤å®š)
    "knowledge_binary": current_binary  # äºŒé€²åˆ¶ç·¨ç¢¼
}
```

---

## âœ¨ å„ªåŒ–æ•ˆæžœ

### API èª¿ç”¨å„ªåŒ–
- **å„ªåŒ–å‰**: 4å€‹ API èª¿ç”¨
- **å„ªåŒ–å¾Œ**: 3å€‹ API èª¿ç”¨
- **æ¸›å°‘**: 25%

### è¨ˆç®—æ•ˆçŽ‡å„ªåŒ–
- **D1**: ä¸å†éœ€è¦ APIï¼Œæœ¬åœ°è¨ˆç®—ï¼ˆå¹¾ä¹Žç„¡å»¶é²ï¼‰
- **D4 é‡è¤‡åˆ¤å®š**: åªæª¢æŸ¥ç•¶å‰è§¸åŠçš„çŸ¥è­˜é»žï¼ˆç¯€çœ 25-100% æª¢æŸ¥æ™‚é–“ï¼‰

### é‚è¼¯æ¸…æ™°åº¦
- **D4 API è·è²¬æ˜Žç¢º**: åªè² è²¬åˆ¤å®šçŸ¥è­˜é»ž
- **æœ¬åœ°è¨ˆç®—è·è²¬æ˜Žç¢º**: D1 è¨ˆç®—æ•¸é‡ï¼ŒD4 åˆ¤å®šé‡è¤‡
- **ç„¡ RAG ä¾è³´**: D4 API ä¸å†ä¾è³´ RAG çµæžœ

---

## ðŸ“ ç¸½çµ

**ç•¶å‰æž¶æ§‹ï¼ˆ3å€‹ API + æœ¬åœ°è¨ˆç®—ï¼‰**ï¼š
- âœ… æ¸›å°‘ API èª¿ç”¨æ¬¡æ•¸
- âœ… æé«˜è¨ˆç®—æ•ˆçŽ‡
- âœ… é‚è¼¯æ›´æ¸…æ™°
- âœ… ç„¡ RAG ä¾è³´
- âœ… å„ªåŒ–é‡è¤‡åˆ¤å®š

ç³»çµ±æ›´ç°¡æ½”ã€æ›´é«˜æ•ˆï¼
