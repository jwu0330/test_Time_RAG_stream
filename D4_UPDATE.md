# D4 重複判斷邏輯更新

## 📋 更新說明

根據您的需求，已將 D4（重複詢問）的判斷邏輯從**簡單的計數檢查**改為**由 AI 分析歷史記錄進行智能判斷**。

---

## 🔄 四向度判斷方式總結

| 向度 | 名稱 | 判斷方式 | 說明 |
|------|------|----------|------|
| **D1** | 知識點數量 | **RAG 實際匹配** | 根據匹配的文件數量判斷：0個/1個/多個 |
| **D2** | 表達錯誤 | **AI 判斷** | LLM 分析問題表達是否有語法或邏輯錯誤 |
| **D3** | 表達詳細度 | **AI 判斷** | LLM 判斷問題描述的詳細程度 |
| **D4** | 重複詢問 | **AI 分析歷史** | LLM 分析當前問題和歷史記錄，判斷是否真的重複 |

---

## 🎯 D4 新邏輯詳解

### 原邏輯（已棄用）
```python
# 簡單計數：連續3次訪問同一知識點 → 重複
if consecutive_count >= 3:
    return "重複狀態"
```

**問題**：
- ❌ 無法區分「相同問題」和「不同角度的問題」
- ❌ 機械式判斷，缺乏語義理解
- ❌ 可能誤判深入探討為重複

### 新邏輯（當前版本）
```python
# AI 智能判斷：分析問題語義和歷史記錄
async def _classify_d4(query, knowledge_points):
    # 1. 獲取最近5條歷史記錄
    recent_history = get_recent_history(n=5)
    
    # 2. 構建歷史上下文
    history_context = format_history_for_ai(recent_history)
    
    # 3. 讓 AI 分析
    prompt = f"""
    當前問題：{query}
    當前知識點：{knowledge_points}
    歷史記錄：{history_context}
    
    判斷是否重複詢問...
    """
    
    # 4. AI 返回判斷結果
    return ai_response  # "重複狀態" 或 "正常狀態"
```

**優勢**：
- ✅ 理解問題的語義內容
- ✅ 區分「重複問題」和「深入探討」
- ✅ 考慮問題的角度和深度變化
- ✅ 更符合人類的判斷邏輯

---

## 📝 AI 判斷標準

AI 會根據以下標準判斷：

### 判定為「重複狀態」的情況：
1. **完全相同的問題**
   - 例：連續3次問「什麼是機器學習？」

2. **換個說法的相同問題**
   - 例：
     - 「什麼是機器學習？」
     - 「機器學習是什麼？」
     - 「請解釋機器學習」
     - 「再說一次機器學習的定義」

3. **已經回答過但繼續追問相同內容**
   - 例：多次問「機器學習的定義」而不深入

### 判定為「正常狀態」的情況：
1. **相同知識點但不同角度**
   - 例：
     - 「什麼是機器學習？」（定義）
     - 「機器學習有哪些類型？」（分類）
     - 「機器學習如何應用？」（應用）

2. **逐步深入的問題**
   - 例：
     - 「什麼是深度學習？」（基礎）
     - 「深度學習的訓練過程？」（深入）
     - 「如何優化深度學習模型？」（進階）

3. **在不同知識點之間切換**
   - 例：
     - 「什麼是機器學習？」
     - 「什麼是深度學習？」
     - 「什麼是 NLP？」

---

## 🔍 實際運作流程

### 流程圖

```
用戶輸入新問題
    ↓
RAG 檢索 → 匹配文件 → 提取知識點
    ↓
獲取最近 5 條歷史記錄
    ↓
構建 AI 分析提示詞：
  - 當前問題
  - 當前知識點
  - 歷史記錄（問題 + 知識點 + 時間）
    ↓
調用 LLM 分析
    ↓
AI 判斷：
  - 是否連續多次詢問相同內容？
  - 問題角度是否不同？
  - 是否在深入探討？
    ↓
返回結果：
  - "重複狀態" 或 "正常狀態"
    ↓
記錄到歷史（保存最近10筆）
```

### 示例：AI 分析提示詞

```
請分析用戶是否在重複詢問同一個知識點。

當前問題：
什麼是機器學習？

當前涉及的知識點：
機器學習基礎

最近的歷史對話記錄：
1. 問題：機器學習是什麼？
   知識點：機器學習基礎
   時間：2025-10-08T12:50:00

2. 問題：請解釋機器學習
   知識點：機器學習基礎
   時間：2025-10-08T12:51:00

3. 問題：機器學習的定義
   知識點：機器學習基礎
   時間：2025-10-08T12:52:00

判斷標準：
- 如果用戶連續多次（3次以上）詢問同一個知識點的相同或相似問題，判定為「重複狀態」
- 如果用戶雖然涉及相同知識點，但問題角度不同、深入程度不同，判定為「正常狀態」
- 如果用戶在不同知識點之間切換，判定為「正常狀態」

請只回答「重複狀態」或「正常狀態」，不需要其他說明。
```

---

## 🧪 測試驗證

### 執行測試

```bash
python test_d4_logic.py
```

### 測試案例

#### 案例 1：連續相同問題（預期：重複狀態）
```
1. 什麼是機器學習？
2. 機器學習是什麼？
3. 請解釋一下機器學習
4. 再說一次機器學習的定義  ← 應判定為「重複狀態」
```

#### 案例 2：相同知識點不同角度（預期：正常狀態）
```
1. 什麼是機器學習？
2. 機器學習有哪些類型？
3. 監督式學習和非監督式學習的區別？
4. 機器學習在實際中如何應用？  ← 應判定為「正常狀態」
```

#### 案例 3：不同知識點切換（預期：正常狀態）
```
1. 什麼是機器學習？
2. 什麼是深度學習？
3. 什麼是自然語言處理？
4. 機器學習和深度學習的關係？  ← 應判定為「正常狀態」
```

---

## ⚙️ 配置參數

在 `config.py` 中可調整：

```python
class Config:
    # 歷史記錄保存數量
    HISTORY_SIZE = 10
    
    # 重複判斷的參考閾值（AI 會參考此值）
    REPETITION_THRESHOLD = 3
    
    # D4 分析時查看的歷史記錄數量
    D4_HISTORY_WINDOW = 5  # 分析最近5條記錄
```

---

## 📊 性能影響

### 額外的 API 調用

每次查詢會調用 LLM **3次**：
1. **D2 判斷**：表達錯誤（快速，max_tokens=10）
2. **D3 判斷**：表達詳細度（快速，max_tokens=20）
3. **D4 判斷**：重複分析（中等，max_tokens=20）

### 時間開銷

- D2 判斷：~0.3-0.5s
- D3 判斷：~0.3-0.5s
- D4 判斷：~0.5-0.8s（需要分析歷史記錄）
- **總額外時間**：~1.1-1.8s

### 優化建議

如果需要加速：
1. 使用更快的模型（如 `gpt-3.5-turbo`）
2. 減少 `D4_HISTORY_WINDOW`（分析更少的歷史記錄）
3. 並行調用 D2、D3、D4（使用 `asyncio.gather()`）

---

## 🔄 代碼變更摘要

### 修改的文件

#### `scenario_module.py`

**修改前**：
```python
def _classify_d4(self, knowledge_points):
    # 簡單計數檢查
    for kp in knowledge_points:
        if self.history_manager.check_repetition(kp):
            return "重複狀態"
    return "正常狀態"
```

**修改後**：
```python
async def _classify_d4(self, query, knowledge_points):
    # AI 智能分析
    recent_history = self.history_manager.get_recent_history(n=5)
    history_context = self._format_history_for_ai(recent_history)
    
    # 構建提示詞讓 AI 判斷
    prompt = f"""..."""
    
    response = self.client.chat.completions.create(...)
    return ai_result  # "重複狀態" 或 "正常狀態"
```

**新增方法**：
```python
def _format_history_for_ai(self, history):
    """格式化歷史記錄供 AI 分析"""
    # 將歷史記錄格式化為易讀的文本
    ...
```

---

## ✅ 驗證清單

- [x] D1 通過 RAG 實際匹配判斷
- [x] D2 由 AI 判斷表達錯誤
- [x] D3 由 AI 判斷表達詳細度
- [x] D4 由 AI 分析歷史記錄判斷重複
- [x] 歷史記錄包含當前知識點
- [x] AI 能訪問最近的歷史對話
- [x] 測試腳本已創建
- [x] 文檔已更新

---

## 🎉 總結

D4 判斷邏輯已成功更新為 **AI 智能分析模式**：

1. ✅ 不再依賴簡單的計數
2. ✅ 將當前知識點傳給 AI
3. ✅ 將歷史對話記錄傳給 AI
4. ✅ AI 進行語義分析和判斷
5. ✅ 能區分「重複」和「深入探討」

**系統現在更智能、更準確！** 🚀
